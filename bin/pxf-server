#!/usr/bin/env ruby
# frozen_string_literal: true

def options(cfg)
  require 'optparse'
  OptionParser.new do |opts|
    opts.summary_indent = '  '
    opts.banner = 'usage: pxf server [options]'
    opts.separator(nil)
    opts.separator('valid options:')
    opts.on('-b', '--bind ADDR', String, 'bind address') do |v|
      cfg.server.host = v
    end
    opts.on('-p', '--port PORT', Integer, 'bind port(default: 1234)') do |v|
      cfg.server.port = v
    end
    opts.on('-k', '--keep-alive', Float, 'set maximum keep-alive time') do |v|
      cfg.server.keep_alive_time = v
    end
    opts.on('-r', '--read_buffer SIZE', Integer, 'set read buffer size (default: 1024)') do |v|
      cfg.server.read_buffer_size = v
    end
    opts.on('-l', '--peer-limit NUMBER', Integer, 'limit number of connections per peer (default: 8)') do |v|
      cfg.server.peer_limit = v
    end
    opts.on('-c', '--command-limit NUMBER', Integer, 'limit of continious processed commands (default: 10)') do |v|
      cfg.server.command_limit = v
    end
    opts.on('-w', '--width WIDTH', Integer, 'set canvas width (default: 800)') do |v|
      cfg.width = v
    end
    opts.on('-h', '--height HEIGHT', Integer, 'set canvas height (default: 600)') do |v|
      cfg.height = v
    end
    opts.on('-f', '--[no-]fullscreen', 'run in fullscreen mode') do |v|
      cfg.fullscreen = v
    end
  end
end

def help(short)
  puts(options(nil), nil) unless short
  puts('Start Pixelflut server.')
  exit
end

help(false) if ARGV[0] == '--help'
help(true) if ARGV[0] == '--short-help'

def create_configuration
  cfg = Pixelflut::App::Configuration.default
  options(cfg).parse!
  cfg
rescue OptionParser::ParseError => e
  $stderr.puts("pxf: #{e}")
  exit 1
end

begin
  require File.realdirpath('../../lib/pixelflut.rb', __FILE__)
  Pixelflut::App.run(create_configuration)
rescue Interrupt
  exit
end
